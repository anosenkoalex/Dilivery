{% extends 'base.html' %}
{% block content %}
<h2>–ó–∞–∫–∞–∑—ã</h2>
{% if current_user.role == 'admin' %}
<a class="btn btn-sm btn-success mb-3 w-100" href="{{ url_for('import_upload') }}">–ò–º–ø–æ—Ä—Ç –∑–∞–∫–∞–∑–æ–≤</a>
{% endif %}
<input
  type="text"
  id="orderSearch"
  placeholder="–ü–æ–∏—Å–∫ –ø–æ –∑–∞–∫–∞–∑–∞–º..."
  class="form-control mb-3 w-100"
/>
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <ul class="flashes">
      {% for category, message in messages %}
        <li class="{{ category }}">{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}
{% endwith %}
<ul class="nav nav-tabs mb-3" id="ordersTabs" role="tablist">
  <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabAll" type="button">–í—Å–µ</button></li>
  <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabZones" type="button">–ü–æ –∑–æ–Ω–∞–º</button></li>
</ul>
<div class="tab-content">
  <div class="tab-pane fade show active" id="tabAll">
    {% for batch, lst in orders_by_batch.items() %}
    <div class="mb-2">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">{{ batch.name }}{% if batch.created_at %} ({{ batch.created_at.strftime('%d.%m.%Y %H:%M') }}){% endif %}</h5>
        <div>
          {% if batch.__class__.__name__ == 'ImportBatch' %}
          {% if current_user.role == 'admin' %}
          <form method="post" action="{{ url_for('delete_batch', batch_id=batch.id) }}" class="d-inline" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –í–°–Æ —Ç–∞–±–ª–∏—Ü—É?');">
            <button type="submit" class="btn btn-sm btn-danger">–£–¥–∞–ª–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É</button>
          </form>
          {% endif %}
          {% endif %}
          <a class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" href="#collapse-{{ loop.index }}-import">–°–≤–µ—Ä–Ω—É—Ç—å / –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å</a>
        </div>
      </div>
      <div class="collapse" id="collapse-{{ loop.index }}-import">
        <div class="table-responsive card mt-2">
        <table class="table table-striped orders-table" id="ordersTable">
          <thead>
            <tr><th>ID</th><th>‚Ññ</th><th>–ö–ª–∏–µ–Ω—Ç</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–ê–¥—Ä–µ—Å</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</th><th>–ó–æ–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</th><th>–ö—É—Ä—å–µ—Ä</th><th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π / –§–æ—Ç–æ</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr>
          </thead>
          <tbody>
            {% for o in lst %}
            <tr data-id="{{ o.id }}" class="{% if not o.zone %}table-warning{% endif %}">
              <td data-label="ID">{{ o.local_order_number }}</td>
              <td data-label="‚Ññ">{{ o.order_number }}</td>
              <td data-label="–ö–ª–∏–µ–Ω—Ç">{{ o.client_name }}</td>
              <td data-label="–¢–µ–ª–µ—Ñ–æ–Ω">{{ o.phone }}</td>
              <td data-label="–ê–¥—Ä–µ—Å">{{ o.address }}</td>
              <td data-label="–°—Ç–∞—Ç—É—Å">
                {% set status_class = {
                    '–°–∫–ª–∞–¥—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞':'bg-secondary',
                    '–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –∫ –¥–æ—Å—Ç–∞–≤–∫–µ':'bg-info',
                    '–í—ã–¥–∞–Ω–æ –Ω–∞ –¥–æ—Å—Ç–∞–≤–∫—É':'bg-warning',
                    '–î–æ—Å—Ç–∞–≤–ª–µ–Ω':'bg-success',
                    '–ü—Ä–æ–±–ª–µ–º–∞':'bg-danger'
                } %}
                <span class="badge {{ status_class.get(o.status, 'bg-secondary') }}">{{ o.status }}</span>
                <button class="btn btn-sm btn-link p-0 ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#statusForm{{ o.id }}">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                <div class="collapse mt-1" id="statusForm{{ o.id }}">
                  <form method="post" class="d-flex">
                    <input type="hidden" name="id" value="{{ o.id }}">
                    <select name="status" class="form-select form-select-sm me-2">
                      {% for st in ['–°–∫–ª–∞–¥—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞','–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –∫ –¥–æ—Å—Ç–∞–≤–∫–µ','–í—ã–¥–∞–Ω–æ –Ω–∞ –¥–æ—Å—Ç–∞–≤–∫—É','–î–æ—Å—Ç–∞–≤–ª–µ–Ω','–ü—Ä–æ–±–ª–µ–º–∞'] %}
                      <option value="{{ st }}" {% if o.status==st %}selected{% endif %}>{{ st }}</option>
                      {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-sm btn-primary">OK</button>
                  </form>
                </div>
              </td>
              <td class="coords-cell" data-label="–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã">
                {{ '‚úî' if o.latitude and o.longitude else '‚úò' }}
                {% if not o.zone %}
                <button class="btn btn-sm btn-outline-primary set-coords" data-order-id="{{ o.id }}" onclick="openMapModal({{ o.id }})">–£–∫–∞–∑–∞—Ç—å —Ç–æ—á–∫—É</button>
                {% endif %}
              </td>
              <td class="zone-cell" data-label="–ó–æ–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∏">{{ o.zone or '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞' }}</td>
              <td class="courier-cell" data-label="–ö—É—Ä—å–µ—Ä">{{ o.courier.name if o.courier else '‚Äî' }}</td>
              <td class="comment-cell" data-label="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π / –§–æ—Ç–æ">
                {% if o.comment %}<div>{{ o.comment }}</div>{% endif %}
                {% if o.photo_filename %}<a href="{{ url_for('static', filename='uploads/' + o.photo_filename) }}" target="_blank">–§–æ—Ç–æ</a>{% endif %}
                {% if current_user.role == 'courier' %}
                <button class="btn btn-sm btn-link p-0 ms-2" type="button" data-bs-toggle="modal" data-bs-target="#commentModal{{ o.id }}">–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ / –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
                <div class="modal fade" id="commentModal{{ o.id }}" tabindex="-1" aria-hidden="true">
                  <div class="modal-dialog"><div class="modal-content"><form method="post" action="{{ url_for('add_comment_photo', order_id=o.id) }}" enctype="multipart/form-data">
                    <div class="modal-header"><h5 class="modal-title">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –∑–∞–∫–∞–∑–∞ {{ o.order_number }}</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                    <div class="modal-body">
                      <div class="mb-3"><label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><textarea class="form-control" name="comment"></textarea></div>
                      <div class="mb-3"><label class="form-label">–§–æ—Ç–æ</label><input type="file" class="form-control" name="photo" accept="image/jpeg,image/png"></div>
                    </div>
                    <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button><button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
                  </form></div></div>
                </div>
                {% endif %}
              </td>
              <td data-label="–î–µ–π—Å—Ç–≤–∏—è">
                <button class="btn btn-sm btn-secondary" data-bs-toggle="modal" data-bs-target="#editModal{{ o.id }}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <div class="modal fade" id="editModal{{ o.id }}" tabindex="-1" aria-hidden="true">
                  <div class="modal-dialog"><div class="modal-content"><form method="post" action="{{ url_for('update_order', order_id=o.id) }}">
                    <div class="modal-header"><h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ {{ o.order_number }}</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                    <div class="modal-body">
                      <div class="mb-3"><label class="form-label">–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label><input type="text" class="form-control" name="client_name" value="{{ o.client_name }}"></div>
                      <div class="mb-3"><label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label><input type="text" class="form-control" name="phone" value="{{ o.phone }}"></div>
                      <div class="mb-3"><label class="form-label">–ê–¥—Ä–µ—Å</label><input type="text" class="form-control" name="address" value="{{ o.address }}"></div>
                      <div class="mb-3"><label class="form-label">–ó–∞–º–µ—Ç–∫–∞</label><textarea class="form-control" name="note">{{ o.note or '' }}</textarea></div>
                      <div class="mb-3"><label class="form-label">–ö—É—Ä—å–µ—Ä</label><select class="form-select" name="courier_id"><option value="">–ê–≤—Ç–æ</option>{% for c in couriers %}<option value="{{ c.id }}" {% if o.courier_id==c.id %}selected{% endif %}>{{ c.name }}</option>{% endfor %}</select></div>
                      <input type="hidden" name="latitude" id="lat-{{ o.id }}" value="{{ o.latitude or '' }}">
                      <input type="hidden" name="longitude" id="lon-{{ o.id }}" value="{{ o.longitude or '' }}">
                      <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#setPointModal" data-input-lat="lat-{{ o.id }}" data-input-lon="lon-{{ o.id }}">{% if o.latitude and o.longitude %}–ò–∑–º–µ–Ω–∏—Ç—å —Ç–æ—á–∫—É{% else %}–£–∫–∞–∑–∞—Ç—å —Ç–æ—á–∫—É{% endif %}</button>
                    </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button><button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
                  </form></div></div>
                </div>
                {% if current_user.role == 'admin' %}
                <form method="post" action="{{ url_for('delete_order', order_id=o.id) }}" class="d-inline" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑?');">
                  <button type="submit" class="btn btn-sm btn-danger mt-1">üóë –£–¥–∞–ª–∏—Ç—å</button>
                </form>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      </div>
    </div>
    {% endfor %}
  </div>
  <div class="tab-pane fade" id="tabZones">
    {% for zn, lst in orders_by_zone.items() %}
    <div class="mb-3">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">{{ zn }}</h5>
        <a class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" href="#collapse-zone-{{ loop.index }}">–°–≤–µ—Ä–Ω—É—Ç—å / –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å</a>
      </div>
      <div class="collapse" id="collapse-zone-{{ loop.index }}">
        <div class="table-responsive card">
          <table class="table table-striped mt-2 orders-table" id="ordersTable">
            <thead><tr><th>ID</th><th>‚Ññ</th><th>–ö–ª–∏–µ–Ω—Ç</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–ê–¥—Ä–µ—Å</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</th><th>–ó–æ–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</th><th>–ö—É—Ä—å–µ—Ä</th><th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π / –§–æ—Ç–æ</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
            <tbody>
              {% for o in lst %}
              <tr data-id="{{ o.id }}" class="{% if not o.zone %}table-warning{% endif %}">
                <td data-label="ID">{{ o.local_order_number }}</td>
                <td data-label="‚Ññ">{{ o.order_number }}</td>
                <td data-label="–ö–ª–∏–µ–Ω—Ç">{{ o.client_name }}</td>
                <td data-label="–¢–µ–ª–µ—Ñ–æ–Ω">{{ o.phone }}</td>
                <td data-label="–ê–¥—Ä–µ—Å">{{ o.address }}</td>
                <td data-label="–°—Ç–∞—Ç—É—Å">
                  {% set status_class = {
                      '–°–∫–ª–∞–¥—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞':'bg-secondary',
                      '–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –∫ –¥–æ—Å—Ç–∞–≤–∫–µ':'bg-info',
                      '–í—ã–¥–∞–Ω–æ –Ω–∞ –¥–æ—Å—Ç–∞–≤–∫—É':'bg-warning',
                      '–î–æ—Å—Ç–∞–≤–ª–µ–Ω':'bg-success',
                      '–ü—Ä–æ–±–ª–µ–º–∞':'bg-danger'
                  } %}
                  <span class="badge {{ status_class.get(o.status, 'bg-secondary') }}">{{ o.status }}</span>
                </td>
                <td class="coords-cell" data-label="–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã">{{ '‚úî' if o.latitude and o.longitude else '‚úò' }}{% if not o.zone %} <button class="btn btn-sm btn-outline-primary set-coords" data-order-id="{{ o.id }}" onclick="openMapModal({{ o.id }})">–£–∫–∞–∑–∞—Ç—å —Ç–æ—á–∫—É</button>{% endif %}</td>
                <td class="zone-cell" data-label="–ó–æ–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∏">{{ o.zone or '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞' }}</td>
                <td class="courier-cell" data-label="–ö—É—Ä—å–µ—Ä">{{ o.courier.name if o.courier else '‚Äî' }}</td>
                <td class="comment-cell" data-label="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π / –§–æ—Ç–æ">{% if o.comment %}<div>{{ o.comment }}</div>{% endif %}{% if o.photo_filename %}<a href="{{ url_for('static', filename='uploads/' + o.photo_filename) }}" target="_blank">–§–æ—Ç–æ</a>{% endif %}</td>
                <td data-label="–î–µ–π—Å—Ç–≤–∏—è">
                  {% if current_user.role == 'admin' %}
                  <form method="post" action="{{ url_for('delete_order', order_id=o.id) }}" class="d-inline" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑?');">
                    <button type="submit" class="btn btn-sm btn-danger">üóë –£–¥–∞–ª–∏—Ç—å</button>
                  </form>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
<div class="modal fade" id="setPointModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <input id="addressSearch" type="text" class="form-control mb-2" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –®–æ–ø–æ–∫–æ–≤–∞ 98)" />
        <div id="pointMap" style="height:400px;"></div>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button><button type="button" class="btn btn-primary" id="savePointBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
    </div>
  </div>
</div>
<div id="mapModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:1050;">
  <div style="background:#fff; margin:50px auto; max-width:600px; padding:10px;">
    <input id="addressSearchModal" type="text" class="form-control mb-2" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –®–æ–ø–æ–∫–æ–≤–∞ 98)" />
    <div id="mapContainer" style="height:400px;"></div>
    <div class="mt-2 text-end">
      <button id="saveCoordsBtn" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="btn btn-secondary" onclick="closeMapModal()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="{{ url_for('static', filename='js/orders.js') }}"></script>
<script>
  window.zonesData = {{ zones|tojson }};
</script>
{% endblock %}
