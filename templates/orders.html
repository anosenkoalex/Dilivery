{% extends 'base.html' %}
{% block content %}
<h2>–ó–∞–∫–∞–∑—ã</h2>
{% if current_user.role == 'admin' %}
<a class="btn btn-sm btn-success mb-3" href="{{ url_for('import_upload') }}">–ò–º–ø–æ—Ä—Ç –∑–∞–∫–∞–∑–æ–≤</a>
{% endif %}
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <ul class="flashes">
      {% for category, message in messages %}
        <li class="{{ category }}">{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}
{% endwith %}
<ul class="nav nav-tabs mb-3" id="ordersTabs" role="tablist">
  <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabAll" type="button">–í—Å–µ</button></li>
  <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabZones" type="button">–ü–æ –∑–æ–Ω–∞–º</button></li>
</ul>
<div class="tab-content">
  <div class="tab-pane fade show active" id="tabAll">
    {% for batch, lst in orders_by_batch.items() %}
    <details class="mb-3" {% if loop.last %}open{% endif %}>
      <summary class="h5 d-flex justify-content-between align-items-center">
        <span>–ò–º–ø–æ—Ä—Ç: {{ batch }}</span>
        {% if current_user.role == 'admin' %}
        <form method="post" action="/orders/delete_table" class="d-inline" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –í–°–Æ —Ç–∞–±–ª–∏—Ü—É?');">
          <input type="hidden" name="batch" value="{{ batch }}">
          <button type="submit" class="btn btn-sm btn-danger">–£–¥–∞–ª–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É</button>
        </form>
        {% endif %}
      </summary>
      <div class="table-responsive mt-2">
        <table class="table table-striped">
          <thead>
            <tr><th>ID</th><th>‚Ññ</th><th>–ö–ª–∏–µ–Ω—Ç</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–ê–¥—Ä–µ—Å</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</th><th>–ó–æ–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</th><th>–ö—É—Ä—å–µ—Ä</th><th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π / –§–æ—Ç–æ</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr>
          </thead>
          <tbody>
            {% for o in lst %}
            <tr data-id="{{ o.id }}" class="{% if not o.zone %}table-warning{% endif %}">
              <td>{{ o.id }}</td>
              <td>{{ o.order_number }}</td>
              <td>{{ o.client_name }}</td>
              <td>{{ o.phone }}</td>
              <td>{{ o.address }}</td>
              <td>
                {% set status_class = {
                    '–°–∫–ª–∞–¥—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞':'bg-secondary',
                    '–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –∫ –¥–æ—Å—Ç–∞–≤–∫–µ':'bg-info',
                    '–í—ã–¥–∞–Ω':'bg-warning',
                    '–î–æ—Å—Ç–∞–≤–ª–µ–Ω':'bg-success'
                } %}
                <span class="badge {{ status_class.get(o.status, 'bg-secondary') }}">{{ o.status }}</span>
                <button class="btn btn-sm btn-link p-0 ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#statusForm{{ o.id }}">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                <div class="collapse mt-1" id="statusForm{{ o.id }}">
                  <form method="post" class="d-flex">
                    <input type="hidden" name="id" value="{{ o.id }}">
                    <select name="status" class="form-select form-select-sm me-2">
                      {% for st in ['–°–∫–ª–∞–¥—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞','–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –∫ –¥–æ—Å—Ç–∞–≤–∫–µ','–í—ã–¥–∞–Ω','–î–æ—Å—Ç–∞–≤–ª–µ–Ω'] %}
                      <option value="{{ st }}" {% if o.status==st %}selected{% endif %}>{{ st }}</option>
                      {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-sm btn-primary">OK</button>
                  </form>
                </div>
              </td>
              <td class="coords-cell">
                {% if o.latitude and o.longitude %}‚úî{% else %}‚úò{% if not o.zone %} <button class="btn btn-sm btn-outline-primary" onclick="openMapModal({{ o.id }})">–£–∫–∞–∑–∞—Ç—å —Ç–æ—á–∫—É</button>{% else %} <a href="{{ url_for('set_coords', order_id=o.id) }}" class="btn btn-sm btn-outline-primary ms-2">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ</a>{% endif %}{% endif %}
              </td>
              <td class="zone-cell">{{ o.zone or '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞' }}</td>
              <td>{{ o.courier.name if o.courier else '‚Äî' }}</td>
              <td>
                {% if o.comment %}<div>{{ o.comment }}</div>{% endif %}
                {% if o.photo_filename %}<a href="{{ url_for('static', filename='uploads/' + o.photo_filename) }}" target="_blank">–§–æ—Ç–æ</a>{% endif %}
                {% if current_user.role == 'courier' %}
                <button class="btn btn-sm btn-link p-0 ms-2" type="button" data-bs-toggle="modal" data-bs-target="#commentModal{{ o.id }}">–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ / –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
                <div class="modal fade" id="commentModal{{ o.id }}" tabindex="-1" aria-hidden="true">
                  <div class="modal-dialog"><div class="modal-content"><form method="post" action="{{ url_for('add_comment_photo', order_id=o.id) }}" enctype="multipart/form-data">
                    <div class="modal-header"><h5 class="modal-title">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –∑–∞–∫–∞–∑–∞ {{ o.order_number }}</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                    <div class="modal-body">
                      <div class="mb-3"><label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><textarea class="form-control" name="comment"></textarea></div>
                      <div class="mb-3"><label class="form-label">–§–æ—Ç–æ</label><input type="file" class="form-control" name="photo" accept="image/jpeg,image/png"></div>
                    </div>
                    <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button><button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
                  </form></div></div>
                </div>
                {% endif %}
              </td>
              <td>
                <button class="btn btn-sm btn-secondary" data-bs-toggle="modal" data-bs-target="#editModal{{ o.id }}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <div class="modal fade" id="editModal{{ o.id }}" tabindex="-1" aria-hidden="true">
                  <div class="modal-dialog"><div class="modal-content"><form method="post" action="{{ url_for('update_order', order_id=o.id) }}">
                    <div class="modal-header"><h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ {{ o.order_number }}</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                    <div class="modal-body">
                      <div class="mb-3"><label class="form-label">–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label><input type="text" class="form-control" name="client_name" value="{{ o.client_name }}"></div>
                      <div class="mb-3"><label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label><input type="text" class="form-control" name="phone" value="{{ o.phone }}"></div>
                      <div class="mb-3"><label class="form-label">–ê–¥—Ä–µ—Å</label><input type="text" class="form-control" name="address" value="{{ o.address }}"></div>
                      <div class="mb-3"><label class="form-label">–ó–∞–º–µ—Ç–∫–∞</label><textarea class="form-control" name="note">{{ o.note or '' }}</textarea></div>
                      <div class="mb-3"><label class="form-label">–ö—É—Ä—å–µ—Ä</label><select class="form-select" name="courier_id"><option value="">–ê–≤—Ç–æ</option>{% for c in couriers %}<option value="{{ c.id }}" {% if o.courier_id==c.id %}selected{% endif %}>{{ c.name }}</option>{% endfor %}</select></div>
                    </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button><button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
                  </form></div></div>
                </div>
                {% if current_user.role == 'admin' %}
                <form method="post" action="{{ url_for('delete_order', order_id=o.id) }}" class="d-inline" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑?');">
                  <button type="submit" class="btn btn-sm btn-danger mt-1">üóë –£–¥–∞–ª–∏—Ç—å</button>
                </form>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </details>
    {% endfor %}
  </div>
  <div class="tab-pane fade" id="tabZones">
    {% for zn, lst in orders_by_zone.items() %}
    <div class="mb-3">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">{{ zn }}</h5>
        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#zoneTable{{ loop.index }}">–°–≤–µ—Ä–Ω—É—Ç—å / –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å</button>
      </div>
      <div class="collapse show" id="zoneTable{{ loop.index }}">
        <div class="table-responsive">
          <table class="table table-striped mt-2">
            <thead><tr><th>ID</th><th>‚Ññ</th><th>–ö–ª–∏–µ–Ω—Ç</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–ê–¥—Ä–µ—Å</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</th><th>–ó–æ–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</th><th>–ö—É—Ä—å–µ—Ä</th><th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π / –§–æ—Ç–æ</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
            <tbody>
              {% for o in lst %}
              <tr data-id="{{ o.id }}" class="{% if not o.zone %}table-warning{% endif %}">
                <td>{{ o.id }}</td>
                <td>{{ o.order_number }}</td>
                <td>{{ o.client_name }}</td>
                <td>{{ o.phone }}</td>
                <td>{{ o.address }}</td>
                <td>
                  {% set status_class = {
                      '–°–∫–ª–∞–¥—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞':'bg-secondary',
                      '–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –∫ –¥–æ—Å—Ç–∞–≤–∫–µ':'bg-info',
                      '–í—ã–¥–∞–Ω':'bg-warning',
                      '–î–æ—Å—Ç–∞–≤–ª–µ–Ω':'bg-success'
                  } %}
                  <span class="badge {{ status_class.get(o.status, 'bg-secondary') }}">{{ o.status }}</span>
                </td>
                <td class="coords-cell">{% if o.latitude and o.longitude %}‚úî{% else %}‚úò{% if not o.zone %} <button class="btn btn-sm btn-outline-primary" onclick="openMapModal({{ o.id }})">–£–∫–∞–∑–∞—Ç—å —Ç–æ—á–∫—É</button>{% endif %}{% endif %}</td>
                <td class="zone-cell">{{ o.zone or '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞' }}</td>
                <td>{{ o.courier.name if o.courier else '‚Äî' }}</td>
                <td>{% if o.comment %}<div>{{ o.comment }}</div>{% endif %}{% if o.photo_filename %}<a href="{{ url_for('static', filename='uploads/' + o.photo_filename) }}" target="_blank">–§–æ—Ç–æ</a>{% endif %}</td>
                <td>
                  {% if current_user.role == 'admin' %}
                  <form method="post" action="{{ url_for('delete_order', order_id=o.id) }}" class="d-inline" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑?');">
                    <button type="submit" class="btn btn-sm btn-danger">üóë –£–¥–∞–ª–∏—Ç—å</button>
                  </form>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
<div class="modal fade" id="setPointModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body"><div id="pointMap" style="height:400px;"></div></div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button><button type="button" class="btn btn-primary" id="savePointBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
    </div>
  </div>
</div>
<div id="mapModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:1050;">
  <div style="background:#fff; margin:50px auto; max-width:600px; padding:10px;">
    <div id="mapContainer" style="height:400px;"></div>
    <div class="mt-2 text-end">
      <button id="saveCoordsBtn" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="btn btn-secondary" onclick="closeMapModal()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="{{ url_for('static', filename='js/orders.js') }}"></script>
{% endblock %}
